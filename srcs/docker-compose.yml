version: '3.3'

services:
  mariadb: #software que orgaiza esos datos y permite interactuar con ellos de manera estructurada (texto autor fecha comentarios)
    container_name: mariadb
    build: ./requirements/mariadb
    restart: always 
    expose: #solo accesible el puerto a otros contenedores dentro de la misma red, si pongo ports tambien sistema anfitri√≥n (host)
     - 3306 # solo debe ser accesible por wordpress
    volumes:
      - DB_Volume:/var/lib/mysql #asi los datos se conservan, incluso si se elimina
    networks:
      - docker-network
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_USER: ngastana
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_DATABASE: wordpress
      MYSQL_HOST: mariadb
      DOMAIN_NAME: ngastana.42.fr

  wordpress:
    container_name: wordpress
    depends_on:
      - mariadb
    build: ./requirements/wordpress
    restart: always
    expose: 
     - 9000 #NGINX envia las peticiones a este puerto para que PHP-FPM las procese. NGINX escucha el puerto 80 o 442 y reenvia la peticion a PHP-FPM. SOLO ACCSIBLE DESDE OS CONTENEDORES (no desde el host)
    volumes:
      - WP_Volume:/var/www/html #se guardan aunque el contenedor se elimine: /var/lib/docker/volumes/WP_Volume/_data/, y aqui se guardan wp-config.php, themes, plugins, una imagen...
    networks:
      - docker-network #en vez de usar su IP se pueden comuicar entre si usando mariadb
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_USER: ngastana
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_DATABASE: wordpress
      MYSQL_HOST: mariadb
      DOMAIN_NAME: ngastana.42.fr
      WP_ADMIN_USER: ngastana
      WP_ADMIN_PASSWORD: ${WP_ADMIN_PASSWORD}
      WP_ADMIN_EMAIL: ngastana@student.42urduliz.com
      WP_CONTRIB_USER: editor
      WP_CONTRIB_PASSWORD: ${WP_CONTRIB_PASSWORD}
      WP_CONTRIB_EMAIL: editor@example.com

  nginx:
    container_name: nginx
    depends_on:
     - wordpress
    build: ./requirements/nginx
    #solo root puede abrir puertos menores a 1024
    ports:
      - "443:443"
    restart: always
    volumes:
      - WP_Volume:/var/www/html
    networks:
      - docker-network

volumes:
  WP_Volume:
    driver: local
    driver_opts:
      type: none
      #device: /home/ngastana/Escritorio/githubincep/srcs/requirements/wordpress/data
      #device: ${PWD}/srcs/requirements/wordpress/data
      device: /home/ngastana/data/wordpress
      o: bind
  DB_Volume:
    driver: local
    driver_opts:
      type: none
      #device: /home/ngastana/Escritorio/githubincep/srcs/requirements/mariadb/data
      #device: ${PWD}/srcs/requirements/mariadb/data
      device: /home/ngastana/data/mariadb
      o: bind

networks:
  docker-network:
    driver: bridge